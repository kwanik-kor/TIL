> 마이크로서비스의 도입으로 인한 빈번한 내부 연동 및 점점 복잡해져 가는 시스템 아키텍처로 외부 연동 역시 빈번해지고 있다. 우리 시스템이 부하를 감당할 수 있다 하더라도, 외부 시스템에 의한 장애 전파는 더 큰 장애로 이어질 수 있으므로 외부 연동에는 늘 주의를 기울여야 한다.

## 1. 타임아웃

외부 연동 서비스에 대하여 적절한 타임아웃을 설정하지 않을 경우, 연동 서비스의 응답이 느리면 처리량이 급격히 떨어질 수 있다. 요청 대기 시간이 늘어날 뿐 아니라, 요청 대기 시간으로 인한 사용자들의 새로고침이 발생하고 이는 요청 수를 기하급수적으로 늘릴 수 있다.

ex) A 서비스 스레드 풀 200개, B 서비스 응답 대기

### 1.1 연결 타임아웃(connection timeout), 읽기 타임아웃(read timeout)

API 연동 통신과정은 간단하게 `연결 > 요청 > 응답 > 종료`의 단계를 거치게 된다.

- 네트워크 연결(3 ~ 5s)
	- 네트워크 상황이나 연결할 서버 상태에 따라 연결에 시간이 오래 걸릴 수 있음
	- 연결 타임아웃(connection timeout)을 설정해 연결 대기 시간을 제한해야 함
- 요청 / 응답(5 ~ 30s)
	- 요청에 대한 응답을 받기까지 시간이 오래 걸리면 대기 시간이 발생할 수 있음
	- 읽기 타임아웃(read timeout)을 설정해 응답 대기 시간을 제한해야 함
	- 실제로 설정하는 값이 무엇인지 잘 확인해야 함
		- Apache HttpClient: Socket timeout
			- 네트워크 패킷 단위를 기준으로 함에 따라, 전체 응답 시간에 대한 타임아웃이 아님
		- OkHttp: call timeout
			- 요청 시작부터 응답까지의 전체 시간 기준으로 설정

## 2. 재시도

간헐적으로 연결에 실패하거나 일시적으로 응답이 느려진 경우, 재시도를 통해 연결 실패를 성공으로 바꿀 수 있음

### 2.1 재시도 가능 조건

> 단, 연동 API를 다시 호출해도 되는 조건인지 반드시 확인해야 한다.

- 단순 조회 기능
- 연결 타임아웃
- 멱등성(idempotent)을 가진 변경 기능
	- 읽기 타임아웃(read-timeout)인 경우 연동 서비스가 요청을 처리하고 있을 수 있으므로 재시도에 주의해야 함
		- 연산을 여러번 적용해도 결과가 달라지지 않는 멱등성을 가진 API만 호출해야 함
	- 실패 원인에 따라 재시도 여부를 결정해야 함. 검증 오류라면 또 요청해도 의미 없음

### 2.2 재시도 횟수와 간격

재시도 횟수
- 재시도 횟수만큼 응답 시간도 함께 증가할 수 있으므로, 대부분 1~2번 정도가 적당

재시도 간격
- 바로 재시도를 할 경우, 동일한 원인으로 오류가 발생할 수 있음
- 일정한 간격을 두거나, 점진적으로 늘려가며 부하를 완화할 수 있음(resilience4j)

### 2.3 재시도 폭풍(retry storm) 안티패턴

재시도를 통해 성공 가능성을 높일 수 있지만, 반대로 연동 서비스에는 더 큰 부하를 줄 수 있음. 이에 따라 연동 서비승



